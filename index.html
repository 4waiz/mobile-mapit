<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Wayfinding | EDGE LIF</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  :root{
    --ink:#e8eef8; --ink-muted:#b7c3d9; --bg:#0e1218; --bg-2:#10161f;
    --panel: rgba(255,255,255,.06); --panel-border: rgba(255,255,255,.08);
    --brand:#9ab6ff; --acc:#4cc3ff; --danger:#ff5a67; --ok:#39e29a; --tag:#263244;
    --route:#fff; --route-bg:#86a7ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 900px at 20% -10%,#1a2230 0%,#0e1218 60%),
    radial-gradient(900px 700px at 120% 120%,#1b2736 0%,#0e1218 60%);}
  body{font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);}

  .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%;}
  .top{
    display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;
    padding:14px 16px;border-bottom:1px solid var(--panel-border);backdrop-filter:blur(6px);
  }
  .brand{display:flex;align-items:center;gap:14px}
  .brand img{height:28px}
  .brand span{color:var(--ink-muted);font-weight:600}
  .search{display:flex;align-items:center;background:var(--panel);border:1px solid var(--panel-border);
    border-radius:16px;padding:10px 14px;max-width:720px;margin:0 auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .search i{color:var(--ink-muted);margin-right:10px}
  .search input{flex:1;background:transparent;border:0;outline:0;color:var(--ink);font-size:16px}
  .credit{font-size:12px;color:var(--ink-muted)}

  .stage{position:relative;overflow:hidden}
  svg{width:100%;height:100%;touch-action:none;background:transparent;cursor:grab}
  svg:active{cursor:grabbing}
  #routeBg{stroke:var(--route-bg);stroke-width:10;fill:none;stroke-linecap:round;stroke-linejoin:round;opacity:.55}
  #route{stroke:var(--route);stroke-width:3.5;fill:none;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:8 10;
         animation:dash 3s linear infinite}
  @keyframes dash{to{stroke-dashoffset:-180}}
  #draft{stroke:#8ea1c9;stroke-dasharray:6 6;stroke-width:3;fill:none}
  #pins text{fill:#0b1020;font-size:14px;font-weight:700;paint-order:stroke;stroke:#fff;stroke-width:2.5px}
  .hud{
    position:absolute;right:16px;top:84px;display:flex;gap:8px;z-index:10}
  .hud .btn{
    width:40px;height:40px;display:grid;place-items:center;border-radius:10px;border:1px solid var(--panel-border);
    background:var(--panel);color:var(--ink);cursor:pointer}
  .hud .btn:hover{background:rgba(255,255,255,.08)}
  .filters{
    display:flex;gap:10px;padding:12px 16px;border-top:1px solid var(--panel-border);
    background:linear-gradient(180deg,rgba(0,0,0,.0),rgba(0,0,0,.15))}
  .chip{
    display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:var(--tag);
    border:1px solid var(--panel-border);color:var(--ink-muted);cursor:pointer;user-select:none}
  .chip i{opacity:.7}
  .chip.active{background:#2f3b52;color:#fff;border-color:#3d4a64}
  .toast{position:absolute;left:50%;top:56%;transform:translateX(-50%);
    color:var(--ink-muted);opacity:.9;font-size:14px}
  @media (max-width:768px){
    .search{max-width:100%}
    .brand span{display:none}
    .hud{top:auto;bottom:110px}
  }
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand"><img src="logo.png" alt="EDGE"><span>Wayfinding</span></div>
    <div class="search">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input id="q" placeholder="Search a room, office, or space…" />
      <i class="fa-solid fa-xmark" id="clearSearch" style="cursor:pointer;color:#9ab"></i>
    </div>
    <div class="credit">Created by Awaiz Ahmed</div>
  </div>

  <div class="stage">
    <svg id="svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-label="Wayfinding map">
      <image id="bg" href="image.png" x="0" y="0" width="100" height="100"/>
      <g id="pins"></g>
      <path id="routeBg" d=""/>
      <path id="route" d=""/>
      <g id="arrow" transform="translate(-100,-100)">
        <path d="M-11,-4 L-11,4 L4,0 Z" fill="var(--brand)" stroke="#fff" stroke-width="1.5"></path>
      </g>
    </svg>

    <div class="hud" aria-label="Map controls">
      <button class="btn" id="zoomIn" title="Zoom in"><i class="fa-solid fa-plus"></i></button>
      <button class="btn" id="zoomOut" title="Zoom out"><i class="fa-solid fa-minus"></i></button>
      <button class="btn" id="reset" title="Reset view"><i class="fa-solid fa-rotate"></i></button>
    </div>

    <div class="toast" id="toast" hidden>Loading…</div>
  </div>

  <div class="filters" id="filters">
    <div class="chip active" data-cat="all"><i class="fa-solid fa-map-location-dot"></i> All</div>
    <div class="chip" data-cat="offices"><i class="fa-solid fa-building"></i> Offices</div>
    <div class="chip" data-cat="training"><i class="fa-solid fa-chalkboard-user"></i> Training</div>
    <div class="chip" data-cat="services"><i class="fa-solid fa-circle-info"></i> Services</div>
    <a class="chip" href="admin.html" title="Admin"><i class="fa-solid fa-screwdriver-wrench"></i> Admin</a>
  </div>
</div>

<script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
<script>
  const $ = sel => document.querySelector(sel);
  const svg = $('#svg'), bg = $('#bg'), pinsLayer = $('#pins'), route = $('#route'), routeBg = $('#routeBg');
  const arrow = $('#arrow'), toast = $('#toast'), q = $('#q');

  let data = { markers:{}, routes:{}, you:null }, pan = null, anim = null;

  const key = (a,b) => `${a}→${b}`;
  const drawD = pts => pts && pts.length ? `M ${pts[0].x} ${pts[0].y} L ${pts.map(p=>`${p.x} ${p.y}`).join(' ')}` : '';

  function notify(msg, show=true){ toast.textContent = msg; toast.hidden = !show; }

  // fit SVG viewBox to the natural image size so your x/y match the JSON
  function fitToImage(){
    const img = new Image();
    img.onload = ()=>{
      const W = img.naturalWidth, H = img.naturalHeight;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      bg.setAttribute('width', W);
      bg.setAttribute('height', H);

      // panzoom
      pan = Panzoom(svg, {
        maxScale: 10, minScale: 0.25,
        startScale: Math.min(svg.parentElement.clientWidth/W, svg.parentElement.clientHeight/H)
      });
      svg.parentElement.addEventListener('wheel', pan.zoomWithWheel);
      $('#zoomIn').onclick = ()=> pan.zoomIn();
      $('#zoomOut').onclick = ()=> pan.zoomOut();
      $('#reset').onclick  = ()=> pan.reset();
    };
    img.src = bg.getAttribute('href');
  }

  function renderPins(filter='all'){
    pinsLayer.innerHTML = '';
    for(const [name,p] of Object.entries(data.markers)){
      if(filter!=='all' && (p.category||'').toLowerCase()!==filter) continue;
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('transform',`translate(${p.x},${p.y})`);
      g.style.cursor = 'pointer';
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r', 8); c.setAttribute('fill', '#ef4444'); c.setAttribute('stroke', '#fff'); c.setAttribute('stroke-width', '2');
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',0); t.setAttribute('y',24); t.setAttribute('text-anchor','middle'); t.textContent = name;
      g.append(c,t);
      g.addEventListener('click', ()=> navigateTo(name));
      pinsLayer.appendChild(g);
    }
    if(data.you){
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('transform',`translate(${data.you.x},${data.you.y})`);
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r', 7); c.setAttribute('fill', '#007aff'); c.setAttribute('stroke', '#fff'); c.setAttribute('stroke-width','3');
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',0); t.setAttribute('y',-16); t.setAttribute('text-anchor','middle');
      t.style.fontSize='16px'; t.textContent='You are here';
      g.append(c,t); pinsLayer.appendChild(g);
    }
  }

  function clearRoute(){ route.setAttribute('d',''); routeBg.setAttribute('d',''); stopArrow(); }
  function showRoute(from,to){
    clearRoute();
    const pts = data.routes[key(from,to)];
    if(!pts){ notify('No saved route for this destination.', true); return; }
    notify('', false);
    const d = drawD(pts);
    route.setAttribute('d', d); routeBg.setAttribute('d', d);
    animateAlong(route);
  }

  function animateAlong(path){
    const L = path.getTotalLength(); if(!L) return;
    let t0 = null;
    function step(ts){
      if(t0===null) t0 = ts;
      const dur = Math.max(2200, L*5);
      const l = ((ts - t0) % dur) / dur * L;
      const p1 = path.getPointAtLength(l);
      const p2 = path.getPointAtLength(Math.min(l+6, L));
      const ang = Math.atan2(p2.y-p1.y, p2.x-p1.x) * 180/Math.PI;
      arrow.setAttribute('transform',`translate(${p1.x},${p1.y}) rotate(${ang})`);
      anim = requestAnimationFrame(step);
    }
    stopArrow(); anim = requestAnimationFrame(step);
  }
  function stopArrow(){ if(anim) cancelAnimationFrame(anim); anim=null; arrow.setAttribute('transform','translate(-100,-100)'); }

  function navigateTo(name){
    if(!data.you){ notify('Set "you" in way.json first.', true); return; }
    showRoute('YOU', name);
    q.value = name;
  }

  async function load(){
    try{
      notify('Loading map…');
      const res = await fetch('way.json', {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      data = await res.json();
      notify('', false);
      fitToImage();
      renderPins('all');
    }catch(e){
      console.error(e);
      notify(`Couldn't read map data. Place way.json next to index.html`);
    }
  }

  // Filters
  $('#filters').addEventListener('click', e=>{
    const chip = e.target.closest('.chip'); if(!chip || !chip.dataset.cat) return;
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    clearRoute(); renderPins(chip.dataset.cat);
  });

  // Search
  q.addEventListener('keydown', e=>{
    if(e.key!=='Enter') return;
    const s = q.value.trim().toLowerCase();
    const hit = Object.keys(data.markers).find(n=>n.toLowerCase()===s || n.toLowerCase().includes(s));
    if(hit) navigateTo(hit); else notify('Location not found.');
  });
  $('#clearSearch').onclick = ()=>{ q.value=''; clearRoute(); };

  load();
</script>
</body>
</html>
