<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Wayfinding Admin</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  :root{ --bg:#0e1218; --panel:#1a2332; --border:#2a3446; --ink:#e8eef8; --mut:#9fb2cc; --brand:#9ab6ff; --ok:#39e29a; --warn:#ffb454; --danger:#ff5a67;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
  aside{border-right:1px solid var(--border);background:#121a26;padding:14px;display:flex;flex-direction:column;gap:10px}
  h3{margin:8px 0 4px;color:#bcd1ea;font-size:12px;letter-spacing:.12em;text-transform:uppercase;opacity:.8}
  .btn{background:#152031;border:1px solid var(--border);border-radius:10px;color:#e8eef8;padding:10px 12px;cursor:pointer}
  .btn:hover{background:#1b2940}
  .btn.primary{background:#284691;border-color:#284691}
  .btn.danger{background:#341f24;border-color:#4a2b31;color:#ffb1ba}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .map{position:relative;overflow:hidden}
  svg{width:100%;height:100%;background:transparent;cursor:crosshair}
  #routeBg{stroke:#86a7ff;stroke-width:10;fill:none;opacity:.55}
  #route{stroke:#fff;stroke-width:3.5;fill:none;stroke-dasharray:8 10;animation:dash 3s linear infinite}
  @keyframes dash{to{stroke-dashoffset:-180}}
  #draft{stroke:#8ea1c9;stroke-dasharray:6 6;stroke-width:3;fill:none}
  #pins text{fill:#0b1020;font-size:14px;font-weight:700;paint-order:stroke;stroke:#fff;stroke-width:2.5px}
  .auth{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.65)}
  .card{background:#101826;border:1px solid var(--border);border-radius:12px;padding:20px;min-width:320px}
  .card input{width:100%;margin:6px 0 12px;background:#111a28;color:#fff;border:1px solid #243047;border-radius:8px;padding:10px}
</style>
</head>
<body>
<div id="gate" class="auth">
  <div class="card">
    <h2 style="margin:0 0 8px">Admin Sign-in</h2>
    <p style="margin:0 0 12px;color:#9fb2cc">Use your assigned credentials.</p>
    <input id="u" placeholder="Username" autocomplete="username" />
    <input id="p" type="password" placeholder="Password" autocomplete="current-password" />
    <button class="btn primary" id="loginBtn">Sign in</button>
    <div id="err" style="color:#ff9b9b;margin-top:8px;display:none">Wrong credentials</div>
  </div>
</div>

<div class="wrap" id="app" style="display:none">
  <aside>
    <h3>Data</h3>
    <div class="row">
      <button class="btn" id="importBtn"><i class="fa-solid fa-file-import"></i>&nbsp; Import JSON</button>
      <button class="btn" id="exportBtn"><i class="fa-solid fa-file-export"></i>&nbsp; Export JSON</button>
    </div>
    <h3>Markers</h3>
    <div class="row">
      <button class="btn" id="addPoint">+ Add point</button>
      <button class="btn" id="setHere">Set “You are here”</button>
    </div>
    <h3>Routing</h3>
    <label>From</label>
    <select id="fromSel" class="btn"></select>
    <label style="margin-top:8px">To</label>
    <select id="toSel" class="btn"></select>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="draw">Draw path</button>
      <button class="btn" id="undo" disabled>Undo</button>
    </div>
    <div class="row">
      <button class="btn primary" id="save" disabled>Save route</button>
      <button class="btn danger" id="del">Delete route</button>
    </div>
    <input id="file" type="file" accept="application/json" hidden>
  </aside>

  <main class="map">
    <svg id="svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <image id="bg" href="image.png" x="0" y="0" width="100" height="100"/>
      <g id="pins"></g>
      <path id="routeBg" d=""/>
      <path id="route" d=""/>
      <path id="draft" d=""/>
    </svg>
  </main>
</div>

<script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
<script>
  // --- auth ---
  const userOK = "awaiz", passOK = "1234";
  const gate = document.getElementById('gate'), app = document.getElementById('app');
  document.getElementById('loginBtn').onclick = ()=>{
    const u = document.getElementById('u').value.trim();
    const p = document.getElementById('p').value;
    if(u===userOK && p===passOK){ gate.style.display='none'; app.style.display='grid'; init(); }
    else document.getElementById('err').style.display='block';
  };

  // --- editor state ---
  const $=q=>document.querySelector(q);
  const svg=$('#svg'), pins=$('#pins'), bg=$('#bg'), route=$('#route'), routeBg=$('#routeBg'), draft=$('#draft');
  const addPointBtn=$('#addPoint'), setHereBtn=$('#setHere'), file=$('#file');
  const fromSel=$('#fromSel'), toSel=$('#toSel'), drawBtn=$('#draw'), undoBtn=$('#undo'), saveBtn=$('#save'), delBtn=$('#del');
  let DATA={markers:{},routes:{},you:null}, placing=null, drawing=false, pts=[], pan=null;

  const key=(a,b)=>`${a}→${b}`; const drawD=pts=>pts.length?`M ${pts[0].x} ${pts[0].y} L ${pts.map(p=>`${p.x} ${p.y}`).join(' ')}`:'';

  async function init(){
    await load();
    fitToImage();
    fillSelects();
    renderPins();
    // controls
    addPointBtn.onclick = ()=> placing = 'point';
    setHereBtn.onclick  = ()=> placing = 'here';
    drawBtn.onclick     = ()=>{ if(!toSel.value) return alert('Choose destination'); drawing=true; pts=[]; draft.setAttribute('d',''); undoBtn.disabled=false; saveBtn.disabled=false; };
    undoBtn.onclick     = ()=>{ if(!drawing||!pts.length) return; pts.pop(); draft.setAttribute('d', drawD(pts)); };
    saveBtn.onclick     = ()=>{ if(!drawing||!pts.length) return; const f=fromSel.value||'YOU', t=toSel.value; DATA.routes[key(f,t)]=pts.slice(); drawing=false; pts=[]; draft.setAttribute('d',''); undoBtn.disabled=true; saveBtn.disabled=true; showRoute(f,t); };
    delBtn.onclick      = ()=>{ const f=fromSel.value||'YOU', t=toSel.value; const k=key(f,t); if(DATA.routes[k] && confirm(`Delete ${k}?`)){ delete DATA.routes[k]; clearRoute(); } };

    // import/export
    document.getElementById('importBtn').onclick = ()=> file.click();
    file.onchange = e=>{
      const f = e.target.files[0]; if(!f) return;
      f.text().then(t=>{ DATA = JSON.parse(t); renderPins(); fillSelects(); }).catch(()=>alert('Invalid JSON'));
      file.value='';
    };
    document.getElementById('exportBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(DATA,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='way.json'; a.click(); URL.revokeObjectURL(a.href);
    };

    // svg clicks
    const svgPoint = e => {
      const pt = svg.createSVGPoint(); pt.x = e.clientX; pt.y = e.clientY;
      return pt.matrixTransform(svg.getScreenCTM().inverse());
    };
    svg.addEventListener('click', e=>{
      const p = svgPoint(e);
      if(placing==='point'){
        const name = prompt('Location name:'); if(!name) return placing=null;
        const cat = (prompt('Category (offices, training, services)','general')||'general').toLowerCase();
        DATA.markers[name] = {x:Math.round(p.x), y:Math.round(p.y), category:cat};
        placing=null; renderPins(); fillSelects();
      }else if(placing==='here'){
        DATA.you = {x:Math.round(p.x), y:Math.round(p.y)}; placing=null; renderPins();
      }else if(drawing){
        pts.push({x:Math.round(p.x), y:Math.round(p.y)}); draft.setAttribute('d', drawD(pts));
      }
    });
  }

  async function load(){
    try{
      const res = await fetch('way.json', {cache:'no-store'}); DATA = await res.json();
      // keep a live working copy in localStorage for convenience
      localStorage.setItem('way.json', JSON.stringify(DATA));
    }catch{
      const cached = localStorage.getItem('way.json');
      if(cached) DATA = JSON.parse(cached);
    }
  }
  function fitToImage(){
    const img=new Image(); img.onload=()=>{
      const W=img.naturalWidth,H=img.naturalHeight; svg.setAttribute('viewBox',`0 0 ${W} ${H}`); bg.setAttribute('width',W); bg.setAttribute('height',H);
      pan = Panzoom(svg,{maxScale:10,minScale:.25,startScale:Math.min(svg.parentElement.clientWidth/W, svg.parentElement.clientHeight/H)});
      svg.parentElement.addEventListener('wheel', pan.zoomWithWheel);
    }; img.src=bg.getAttribute('href');
  }

  function fillSelects(){
    fromSel.innerHTML = ''; toSel.innerHTML = '';
    const add=(sel,v)=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); };
    add(fromSel,'YOU'); Object.keys(DATA.markers).sort().forEach(n=>{ add(fromSel,n); add(toSel,n); });
  }

  function renderPins(){
    pins.innerHTML=''; for(const [name,p] of Object.entries(DATA.markers)){
      const g = document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('transform',`translate(${p.x},${p.y})`); g.style.cursor='pointer';
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('r',8); c.setAttribute('fill','#ef4444'); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','2');
      const t = document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',0); t.setAttribute('y',24); t.setAttribute('text-anchor','middle'); t.textContent=name;
      g.append(c,t); pins.appendChild(g);
    }
    if(DATA.you){
      const g = document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('transform',`translate(${DATA.you.x},${DATA.you.y})`);
      const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('r',7); c.setAttribute('fill','#007aff'); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','3');
      const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',0); t.setAttribute('y',-16); t.setAttribute('text-anchor','middle'); t.style.fontSize='16px'; t.textContent='You are here';
      g.append(c,t); pins.appendChild(g);
    }
  }

  function clearRoute(){ route.setAttribute('d',''); routeBg.setAttribute('d',''); draft.setAttribute('d',''); }
  function showRoute(f,t){ const arr=DATA.routes[key(f,t)]; if(!arr) return; const d=drawD(arr); route.setAttribute('d',d); routeBg.setAttribute('d',d); }
</script>
</body>
</html>
